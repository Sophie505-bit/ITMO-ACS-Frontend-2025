<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workouts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="mb-3">
        <a href="../index.html" class="btn btn-back light-blue-text">← Back to Home</a>
    </div>
    <h2 class="form-title">Workouts</h2>

    <!-- Фильтры поиска -->
    <div class="card glass-card mb-4">
        <div class="card-body">
            <h5 class="card-title light-blue-text mb-3">Filter Workouts</h5>
            <div class="row">
                <div class="col-md-4">
                    <label for="level" class="form-label">Level</label>
                    <select class="form-control" id="level">
                        <option value="all">All Levels</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="type" class="form-label">Type</label>
                    <select class="form-control" id="type">
                        <option value="all">All Types</option>
                        <option value="cardio">Cardio</option>
                        <option value="strength">Strength</option>
                        <option value="yoga">Yoga & Flexibility</option>
                        <option value="stretching">Stretching</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="duration" class="form-label">Duration</label>
                    <select class="form-control" id="duration">
                        <option value="all">Any Duration</option>
                        <option value="short">Short (10-20 min)</option>
                        <option value="medium">Medium (20-40 min)</option>
                        <option value="long">Long (40+ min)</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-form-primary" onclick="filterWorkouts()">Apply Filters</button>
                <button class="btn btn-secondary-elegant ms-2" onclick="resetFilters()">Reset</button>
            </div>
        </div>
    </div>

    <!-- Индикатор загрузки -->
    <div id="loadingIndicator" class="text-center mb-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading workouts...</p>
    </div>

    <!-- Результаты поиска -->
    <div id="workoutResults" class="row">
        <!-- Тренировки будут загружаться здесь через JavaScript -->
    </div>
</div>

<script>
// Базовый URL для API (JSON Server)
const API_URL = 'http://localhost:3000';

// Функция для показа/скрытия индикатора загрузки
function showLoading(show) {
    document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

// Функция загрузки всех тренировок
async function loadWorkouts() {
    showLoading(true);
    
    try {
        const response = await fetch(`${API_URL}/workouts`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const workouts = await response.json();
        
        // Добавляем информацию о выполнении для каждой тренировки
        const workoutsWithStatus = await addCompletionStatus(workouts);
        
        displayWorkouts(workoutsWithStatus);
        return workoutsWithStatus;
    } catch (error) {
        console.error('Error loading workouts:', error);
        showError('Failed to load workouts. Please try again.');
        return [];
    } finally {
        showLoading(false);
    }
}

// Функция для добавления статуса выполнения тренировок
async function addCompletionStatus(workouts) {
    try {
        // Получаем текущего пользователя
        const currentUser = JSON.parse(localStorage.getItem('current_user'));
        if (!currentUser) return workouts;
        
        // Получаем выполненные тренировки пользователя
        const response = await fetch(`${API_URL}/completedWorkouts?userId=${currentUser.id}`);
        if (!response.ok) return workouts;
        
        const completedWorkouts = await response.json();
        const completedIds = completedWorkouts.map(w => w.workoutId);
        
        // Добавляем статус к каждой тренировке
        return workouts.map(workout => ({
            ...workout,
            completed: completedIds.includes(workout.id.toString()),
            completionDate: completedWorkouts.find(w => w.workoutId === workout.id.toString())?.date
        }));
    } catch (error) {
        console.error('Error loading completion status:', error);
        return workouts;
    }
}

// Функция фильтрации тренировок через API
async function filterWorkouts() {
    const level = document.getElementById('level').value;
    const type = document.getElementById('type').value;
    const duration = document.getElementById('duration').value;
    
    showLoading(true);
    
    try {
        // Создаем параметры запроса
        const params = new URLSearchParams();
        
        if (level !== 'all') params.append('level', level);
        if (type !== 'all') params.append('type', type);
        if (duration !== 'all') params.append('duration', duration);
        
        const queryString = params.toString();
        const url = queryString ? `${API_URL}/workouts?${queryString}` : `${API_URL}/workouts`;
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const filteredWorkouts = await response.json();
        
        // Добавляем информацию о выполнении
        const workoutsWithStatus = await addCompletionStatus(filteredWorkouts);
        
        displayWorkouts(workoutsWithStatus);
    } catch (error) {
        console.error('Error filtering workouts:', error);
        showError('Failed to filter workouts. Please try again.');
    } finally {
        showLoading(false);
    }
}

// Функция для фильтрации на клиенте (альтернатива, если JSON Server не работает)
function filterWorkoutsClientSide() {
    const level = document.getElementById('level').value;
    const type = document.getElementById('type').value;
    const duration = document.getElementById('duration').value;

    const filteredWorkouts = workouts.filter(workout => {
        return (level === 'all' || workout.level === level) &&
               (type === 'all' || workout.type === type) &&
               (duration === 'all' || workout.duration === duration);
    });

    displayWorkouts(filteredWorkouts);
}

// Функция сброса фильтров
function resetFilters() {
    document.getElementById('level').value = 'all';
    document.getElementById('type').value = 'all';
    document.getElementById('duration').value = 'all';
    loadWorkouts();
}

// Функция отображения тренировок
function displayWorkouts(workoutsToShow) {
    const container = document.getElementById('workoutResults');
    container.innerHTML = '';

    if (workoutsToShow.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <div class="card glass-card">
                    <div class="card-body">
                        <h5 class="light-blue-text">No workouts found</h5>
                        <p class="text-muted">Try adjusting your filters to see more results.</p>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    workoutsToShow.forEach(workout => {
        const workoutCard = `
            <div class="col-md-6 mb-4">
                <div class="card glass-card h-100">
                    <img src="${workout.image}" class="card-img-top workout-image" alt="${workout.name}" 
                         onerror="this.src='https://via.placeholder.com/400x250/4f86f7/ffffff?text=Workout+Image'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title light-blue-text">${workout.name}</h5>
                            <div>
                                <span class="badge bg-primary me-1">${workout.level}</span>
                                ${workout.completed ? 
                                    '<span class="badge bg-success"><i class="fas fa-check"></i> Completed</span>' : 
                                    ''}
                            </div>
                        </div>
                        <p class="card-text">${workout.description}</p>
                        <div class="workout-details mb-3">
                            <small class="text-muted">
                                <strong>Type:</strong> ${workout.type} | 
                                <strong>Duration:</strong> ${workout.duration} | 
                                <strong>Calories:</strong> ${workout.calories}
                            </small>
                            ${workout.completed ? 
                                `<br><small class="text-success">
                                    <i class="fas fa-calendar-check"></i> 
                                    Completed on ${new Date(workout.completionDate).toLocaleDateString()}
                                </small>` : 
                                ''}
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="workout-details.html?id=${workout.id}" class="btn btn-form-primary">View Details</a>
                            ${!workout.completed ? 
                                `<button onclick="markWorkoutAsCompleted(${workout.id}, '${workout.name}')" 
                                        class="btn btn-outline-success">
                                    <i class="fas fa-check"></i> Mark as Completed
                                </button>` : 
                                ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += workoutCard;
    });
}

// Функция отметки тренировки как выполненной через API
async function markWorkoutAsCompleted(workoutId, workoutName) {
    try {
        // Получаем текущего пользователя
        const currentUser = JSON.parse(localStorage.getItem('current_user'));
        if (!currentUser) {
            alert('Please login to track your progress!');
            return;
        }

        // Создаем объект выполненной тренировки
        const completedWorkout = {
            workoutId: workoutId.toString(),
            workoutName: workoutName,
            userId: currentUser.id,
            date: new Date().toISOString(),
            timestamp: Date.now()
        };

        // Отправляем POST запрос на сервер
        const response = await fetch(`${API_URL}/completedWorkouts`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(completedWorkout)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        // Показываем уведомление
        showNotification(`Great job! "${workoutName}" marked as completed.`, 'success');
        
        // Обновляем отображение тренировок
        setTimeout(() => {
            loadWorkouts();
        }, 1000);

    } catch (error) {
        console.error('Error marking workout as completed:', error);
        showNotification('Failed to mark workout as completed. Please try again.', 'danger');
    }
}

// Функция показа ошибки
function showError(message) {
    const container = document.getElementById('workoutResults');
    container.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <h5>Error</h5>
                <p>${message}</p>
                <button onclick="loadWorkouts()" class="btn btn-sm btn-outline-danger">Retry</button>
            </div>
        </div>
    `;
}

// Функция показа уведомления
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        max-width: 400px;
    `;
    
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем, доступен ли JSON Server
    checkServerAvailability()
        .then(isAvailable => {
            if (isAvailable) {
                console.log('JSON Server is available, using API mode');
                loadWorkouts();
            } else {
                console.log('JSON Server is not available, using client-side mode');
                // Используем локальные данные
                displayWorkouts(workouts);
            }
        })
        .catch(() => {
            console.log('Failed to check server, using client-side mode');
            displayWorkouts(workouts);
        });
});

// Функция проверки доступности сервера
async function checkServerAvailability() {
    try {
        const response = await fetch(`${API_URL}/workouts`, {
            method: 'HEAD',
            mode: 'no-cors' // Используем no-cors для простой проверки
        });
        return true;
    } catch (error) {
        return false;
    }
}

// Локальные данные на случай, если сервер недоступен
const workouts = [
    {
        id: 1,
        name: "Cardio Training",
        type: "cardio",
        level: "beginner",
        duration: "medium",
        image: "../images/cardio.jpeg",
        description: "Improve your endurance with our cardio exercises. Perfect for burning calories and strengthening your heart.",
        calories: "300-400",
        equipment: "None"
    },
    {
        id: 2,
        name: "Strength Training",
        type: "strength",
        level: "intermediate",
        duration: "long",
        image: "../images/strength.jpeg",
        description: "Build muscle and increase strength with our weight training programs. Suitable for all fitness levels.",
        calories: "400-500",
        equipment: "Dumbbells, Resistance Bands"
    },
    {
        id: 3,
        name: "Yoga & Flexibility",
        type: "yoga",
        level: "beginner",
        duration: "medium",
        image: "../images/yoga.jpeg",
        description: "Improve flexibility and reduce stress. Perfect for mindfulness and body awareness.",
        calories: "200-300",
        equipment: "Yoga Mat"
    },
    {
        id: 4,
        name: "Stretching & Mobility",
        type: "stretching",
        level: "beginner",
        duration: "short",
        image: "../images/stretching.jpeg",
        description: "Enhance your mobility and prevent injuries with proper stretching techniques.",
        calories: "100-150",
        equipment: "None"
    },
    {
        id: 5,
        name: "Advanced HIIT",
        type: "cardio",
        level: "advanced",
        duration: "short",
        image: "../images/hiit.jpeg",
        description: "High-intensity interval training for maximum calorie burn and endurance building.",
        calories: "400-600",
        equipment: "None"
    },
    {
        id: 6,
        name: "Power Lifting",
        type: "strength",
        level: "advanced",
        duration: "long",
        image: "../images/power-lifting.jpeg",
        description: "Build maximum strength with heavy compound movements and proper technique.",
        calories: "500-700",
        equipment: "Barbell, Weights"
    }
];
</script>

<!-- Добавляем Font Awesome для иконок -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="../script.js"></script>
</body>
</html>